<!--
WARNING: This file is automatically generated from scripts/motion/subsystems/collision_material_system/README.md.
Do not edit this file directly. Make changes to the source README.md instead.
Last updated: 2025-04-24 19:28:21
-->

# CollisionMaterialSystem

A subsystem for the MotionSystem that provides material-specific physics properties based on collision context.

## Overview

The CollisionMaterialSystem acts as a central repository and lookup service for surface material properties (friction, bounce, sound). It reads these properties directly from the global `PhysicsConfig` resource (`default_physics.tres`) during initialization.

When an entity collides with something, other systems (like `CollisionMotionResolver`) determine the type of material involved (e.g., "ice", "mud", "default"). They then query this system to get the physics parameters associated with that material type.

## Features

- Stores physics properties (friction, bounce, sound) associated with different material names ("default", "ice", "mud", "rubber").
- Loads these properties directly from the `PhysicsConfig` resource injected by `MotionSystemCore`.
- Provides a method (`get_material_properties`) to retrieve the properties dictionary for a given material name.

## Integration with MotionSystem

The CollisionMaterialSystem implements the `IMotionSubsystem` interface and is registered with the `MotionSystemCore`.

- **Initialization:** `MotionSystemCore` calls `set_physics_config(config)` on this system, passing the loaded `PhysicsConfig` resource.
- **Property Loading:** The `set_physics_config` method triggers `_update_materials_from_config`, which reads properties like `default_material_friction`, `ice_material_bounce`, etc., from the `PhysicsConfig` and stores them internally in the `_registered_materials` dictionary.
- **Usage:** Other systems, primarily `CollisionMotionResolver`, query this system using `get_material_properties(material_type)` to get the friction and bounce values needed to create `ImpactSurfaceData` for collision calculations.

## Usage

1.  **Define Properties in PhysicsConfig:** Ensure all material properties are defined in `PhysicsConfig.gd` (`@export var`) and have corresponding values set in `resources/physics/default_physics.tres`.
    ```gdscript
    # In PhysicsConfig.gd
    @export var default_material_friction: float = 0.3
    @export var default_material_bounce: float = 0.8
    @export var ice_material_friction: float = 0.05
    # ... etc ...

    # In default_physics.tres
    [resource]
    script = ExtResource("...")
    default_material_friction = 0.3
    default_material_bounce = 0.8
    ice_material_friction = 0.05
    # ... etc ...
    ```

2.  **Initialization (Automatic):** `MotionSystemCore` automatically loads `default_physics.tres` and passes the `PhysicsConfig` instance to this system via `set_physics_config`. The system then populates its internal `_registered_materials` dictionary.

3.  **Determine Material Type:** The colliding entity (e.g., `PlayerCharacter`) or `CollisionMotionResolver` determines the name ("default", "ice", etc.) of the material involved in the collision (usually based on the collider's properties or metadata).

4.  **Query Properties:** The system needing the properties (typically `CollisionMotionResolver`) gets this subsystem and queries it:
    ```gdscript
    # Example within CollisionMotionResolver._create_impact_surface_data
    var collision_material_system = _core.get_subsystem("CollisionMaterialSystem")
    var material_type = collision_info.get("material", "default") # Get material name
    var elasticity = 0.5 # Fallback
    var friction = 0.3 # Fallback

    if collision_material_system:
        var material_properties = collision_material_system.get_material_properties(material_type)
        elasticity = material_properties.get("bounce", elasticity)
        friction = material_properties.get("friction", friction)
    
    var surface_data = ImpactSurfaceData.new(normal, elasticity, friction)
    ```

## Extending with New Material Types

To add a new material type (e.g., "sand"):

1.  **Add Properties to `PhysicsConfig.gd`:**
    ```gdscript
    @export var sand_material_friction: float = 0.7
    @export var sand_material_bounce: float = 0.4
    ```
2.  **Add Values to `default_physics.tres`:**
    ```gdscript
    [resource]
    # ... other properties ...
    sand_material_friction = 0.7
    sand_material_bounce = 0.4
    ```
3.  **Update `CollisionMaterialSystem._update_materials_from_config`:** Add an entry for the new material type:
    ```gdscript
    _registered_materials["sand"] = {
        "friction": _physics_config.get_param("sand_material_friction", "default") if _physics_config else SAND_FRICTION, # Define SAND_FRICTION constant for fallback
        "bounce": _physics_config.get_param("sand_material_bounce", "default") if _physics_config else SAND_BOUNCE, # Define SAND_BOUNCE constant for fallback
        "sound": "sand_impact" # Add appropriate sound key
    }
    ```
4.  **Update Collision Detection:** Ensure your game logic correctly identifies "sand" materials during collisions and includes `"material": "sand"` in the `collision_info` dictionary passed to the `MotionSystem`.
